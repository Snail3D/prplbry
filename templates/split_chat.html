<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>prplbry</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --text-primary: #e0e0e0;
            --text-secondary: #888;
            --accent: #ff6b35;
            --border: #2a2a2a;
            --input-bg: #1a1a1a;
        }

        .light-mode {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e5e5e5;
            --text-primary: #1a1a1a;
            --text-secondary: #666;
            --border: #e0e0e0;
            --input-bg: #f9f9f9;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Desktop: Side-by-side */
        @media (min-width: 769px) {
            body {
                flex-direction: row;
            }

            .chat-section {
                flex: 1;
                max-height: none;
                border-right: 1px solid var(--border);
                border-bottom: none;
            }

            .prd-section {
                flex: 1;
            }
        }

        /* Mobile: Stacked (chat top, PRD bottom) */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
        }

        /* Chat Section */
        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-bottom: 1px solid var(--border);
            background: var(--bg-primary);
            min-width: 0;
        }

        .chat-header {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        .chat-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .mode-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 12px;
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .mode-toggle:hover {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        .light-mode .mode-toggle {
            background: var(--bg-primary);
            border: 1px solid var(--border);
        }

        .light-mode .mode-toggle:hover {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
        }

        .message.user {
            align-self: flex-end;
            background: var(--accent);
            color: #fff;
        }

        .message.assistant {
            align-self: flex-start;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .input-area {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
            background: var(--bg-secondary);
        }

        .chat-input {
            flex: 1;
            padding: 10px 14px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }

        .chat-input:focus {
            border-color: var(--accent);
        }

        .send-btn {
            padding: 10px 20px;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
            position: relative;
            overflow: hidden;
            min-width: 80px;
            text-align: center;
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .send-btn.fade-out {
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .send-btn.fade-in {
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
        }

        /* PRD Section - BOTTOM */
        .prd-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-primary);
        }

        .prd-header {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        .prd-title-text {
            font-size: 12px;
            font-weight: 500;
            color: var(--accent);
        }

        .copy-btn {
            background: none;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 12px;
            color: var(--text-secondary);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .prd-editor {
            flex: 1;
            padding: 16px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'SF Mono', Monaco, 'Consolas', monospace;
            font-size: 11px;
            line-height: 1.6;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: none;
            outline: none;
            resize: none;
        }

        /* API Key Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
        }

        .modal h3 {
            font-size: 16px;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .modal p {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .api-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 13px;
            margin-bottom: 16px;
            outline: none;
        }

        .api-input:focus {
            border-color: var(--accent);
        }

        .modal-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        /* Donation Modal */
        .donation-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .donation-btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .donation-btn.yes {
            background: var(--accent);
            color: #fff;
        }

        .donation-btn.no {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Privacy Modal */
        .privacy-link {
            font-size: 11px;
            color: var(--text-secondary);
            text-decoration: underline;
            cursor: pointer;
            margin-top: 12px;
            display: inline-block;
        }

        .privacy-link:hover {
            color: var(--text-primary);
        }

        .privacy-content {
            font-size: 12px;
            color: var(--text-primary);
            line-height: 1.8;
            max-height: 60vh;
            overflow-y: auto;
        }

        .privacy-content h4 {
            font-size: 14px;
            color: var(--accent);
            margin: 16px 0 8px 0;
        }

        .privacy-content p {
            margin-bottom: 12px;
        }

        .privacy-content ul {
            margin-left: 20px;
            margin-bottom: 12px;
        }

        .privacy-content li {
            margin-bottom: 8px;
        }

        /* Backroom Modal */
        .backroom-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .backroom-speaker {
            padding: 12px;
            border-radius: 8px;
            background: var(--bg-tertiary);
        }

        .backroom-speaker.stool {
            border-left: 3px solid #e74c3c;
        }

        .backroom-speaker.gomer {
            border-left: 3px solid #27ae60;
        }

        .backroom-name {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stool .backroom-name {
            color: #e74c3c;
        }

        .gomer .backroom-name {
            color: #27ae60;
        }

        .backroom-message {
            font-size: 12px;
            color: var(--text-primary);
            line-height: 1.5;
        }

        .backroom-close {
            width: 100%;
            padding: 10px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            margin-top: 12px;
        }

        .backroom-close:hover {
            background: var(--border);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- API Key Modal -->
    <div class="modal-overlay" id="apiKeyModal">
        <div class="modal">
            <h3>üîë Groq API Key</h3>
            <p>Enter your free Groq API key to continue. Get it at console.groq.com</p>
            <input type="password" class="api-input" id="apiKeyInput" placeholder="gsk_...">
            <button class="modal-btn" onclick="saveApiKey()">Start</button>
            <span class="privacy-link" onclick="showPrivacy()">Privacy (we collect nothing)</span>
        </div>
    </div>

    <!-- Privacy Modal -->
    <div class="modal-overlay" id="privacyModal">
        <div class="modal">
            <h3>üîí Privacy (Super Simple)</h3>
            <div class="privacy-content">
                <h4>What we DON'T collect:</h4>
                <ul>
                    <li><strong>No names</strong> - We don't know who you are</li>
                    <li><strong>No emails</strong> - We can't email you</li>
                    <li><strong>No accounts</strong> - You don't sign up for anything</li>
                    <li><strong>No tracking</strong> - We don't follow you around</li>
                    <li><strong>No cookies</strong> - Well, just one tiny cookie to keep your chat working, but it disappears when you close your browser</li>
                    <li><strong>No selling your stuff</strong> - We have nothing to sell!</li>
                </ul>

                <h4>What DO we do with your stuff?</h4>
                <p>Nothing! Your chat messages and PRDs are gone as soon as you close the tab. We don't save them. We can't even see them.</p>

                <h4>So how does this work?</h4>
                <p>You bring your own Groq API key. That key talks directly to Groq. Your messages go from your computer to Groq and back. We're just the middleman who sets up the conversation.</p>

                <p><strong>We're like a paper cup - you use it, then it's gone. We keep nothing.</strong></p>

                <h4>Why?</h4>
                <p>Because privacy should be simple. No fine print. No tricks. Just nothing.</p>

                <h4>The boring part:</h4>
                <p>We use Cloudflare to keep the site fast and safe from bad guys. That's it.</p>
            </div>
            <button class="modal-btn" onclick="closePrivacy()" style="margin-top: 16px;">Got it</button>
        </div>
    </div>

    <!-- Backroom Modal -->
    <div class="modal-overlay" id="backroomModal">
        <div class="modal">
            <h3 style="color: var(--accent);">üéß The Back Room</h3>
            <div class="backroom-content">
                <div class="backroom-speaker stool">
                    <div class="backroom-name">üî¥ Stool (Skeptic)</div>
                    <div class="backroom-message" id="stoolMessage"></div>
                </div>
                <div class="backroom-speaker gomer">
                    <div class="backroom-name">üü¢ Gomer (Optimist)</div>
                    <div class="backroom-message" id="gomerMessage"></div>
                </div>
            </div>
            <button class="backroom-close" onclick="closeBackroom()">Got it, back to work</button>
        </div>
    </div>

    <!-- Donation Modal -->
    <div class="modal-overlay" id="donationModal">
        <div class="modal">
            <h3 style="color: var(--accent);">Hot dog! Look at you go!</h3>
            <p id="donationMessage" style="color: var(--text-primary); line-height: 1.6;"></p>
            <div class="donation-buttons">
                <button class="donation-btn yes" onclick="donateYes()">Yes, I'll support</button>
                <button class="donation-btn no" onclick="donateNo()">No thanks</button>
            </div>
        </div>
    </div>

    <!-- Chat Section -->
    <div class="chat-section">
        <div class="chat-header">
            <div class="chat-title">prplbry</div>
            <button class="mode-toggle" onclick="toggleMode()" id="modeBtn">‚òÄÔ∏è Day</button>
        </div>

        <div class="messages" id="messages">
            <div class="message assistant">
                Good evening. Let's plan.<br><br>
                What are we building today?
            </div>
        </div>

        <div class="input-area">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <!-- PRD Section -->
    <div class="prd-section">
        <div class="prd-header">
            <span class="prd-title-text" id="prdTitle"></span>
            <button class="copy-btn" onclick="copyPRD()">Copy</button>
        </div>
        <textarea class="prd-editor" id="prdEditor" readonly placeholder="Your PRD will appear here as we chat..."></textarea>
    </div>

    <script>
        let sessionId = '{{ session_id }}' || generateUUID();
        let groqApiKey = sessionStorage.getItem('groqApiKey') || '';
        let donationRefusals = 0;
        const MAX_DONATION_REQUESTS = 2;
        const GROQ_MODEL = 'llama-3.3-70b-versatile';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (!groqApiKey) {
                document.getElementById('apiKeyModal').classList.add('active');
            } else {
                loadChatHistory();
            }

            // Start language cycling animation on send button
            startLanguageCycling();
        });

        // Language cycling for send button
        const sendButtonTexts = [
            { text: "Send", lang: "English" },
            { text: "Enviar", lang: "Spanish" },
            { text: "Envoyer", lang: "French" },
            { text: "Invia", lang: "Italian" },
            { text: "Enviar", lang: "Portuguese" },
            { text: "ÂèëÈÄÅ", lang: "Chinese" },
            { text: "ÈÄÅ‰ø°", lang: "Japanese" },
            { text: "Î≥¥ÎÇ¥Í∏∞", lang: "Korean" },
            { text: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å", lang: "Russian" },
            { text: "Senden", lang: "German" },
            { text: "Versturen", lang: "Dutch" },
            { text: "Wy≈õlij", lang: "Polish" },
            { text: "G√∂nder", lang: "Turkish" },
            { text: "◊©◊ú◊ó", lang: "Hebrew" },
            { text: "ÿ•ÿ±ÿ≥ÿßŸÑ", lang: "Arabic" },
            { text: "‡§≠‡•á‡§ú‡•á‡§Ç", lang: "Hindi" },
            { text: "Kirim", lang: "Indonesian" },
            { text: "G·ª≠i", lang: "Vietnamese" },
            { text: "‡∏™‡πà‡∏á", lang: "Thai" }
        ];

        let currentLangIndex = 0;
        let isCycling = true;

        function startLanguageCycling() {
            const sendBtn = document.getElementById('sendBtn');

            // Cycle every 2.5 seconds
            setInterval(() => {
                if (!isCycling) return;

                // Fade out
                sendBtn.classList.add('fade-out');

                setTimeout(() => {
                    // Change text
                    currentLangIndex = (currentLangIndex + 1) % sendButtonTexts.length;
                    sendBtn.textContent = sendButtonTexts[currentLangIndex].text;
                    sendBtn.title = sendButtonTexts[currentLangIndex].lang;

                    // Fade in
                    sendBtn.classList.remove('fade-out');
                    sendBtn.classList.add('fade-in');
                }, 500); // Wait for fade out to complete

            }, 2500); // Change every 2.5 seconds
        }

        // Stop cycling when user focuses on input
        const chatInput = document.getElementById('chatInput');
        chatInput.addEventListener('focus', () => {
            isCycling = false;
            // Reset to English
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.classList.add('fade-out');
            setTimeout(() => {
                sendBtn.textContent = 'Send';
                sendBtn.title = 'English';
                sendBtn.classList.remove('fade-out');
                sendBtn.classList.add('fade-in');
            }, 500);
        });

        chatInput.addEventListener('blur', () => {
            isCycling = true;
        });

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0;
                return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });
        }

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (key && key.startsWith('gsk_')) {
                groqApiKey = key;
                sessionStorage.setItem('groqApiKey', key);
                document.getElementById('apiKeyModal').classList.remove('active');
                loadChatHistory();
            } else {
                alert('Please enter a valid Groq API key (starts with gsk_)');
            }
        }

        function toggleMode() {
            document.body.classList.toggle('light-mode');
            const btn = document.getElementById('modeBtn');
            if (document.body.classList.contains('light-mode')) {
                btn.textContent = 'üåô Dark';
            } else {
                btn.textContent = '‚òÄÔ∏è Day';
            }
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            // Add user message
            addMessage('user', message);
            input.value = '';

            // Disable send
            document.getElementById('sendBtn').disabled = true;

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        session_id: sessionId,
                        grok_api_key: groqApiKey
                    })
                });

                const data = await response.json();
                sessionId = data.session_id || sessionId;

                // Add assistant message
                if (data.message) {
                    addMessage('assistant', data.message);
                }

                // Update PRD
                if (data.prd_preview) {
                    document.getElementById('prdEditor').value = data.prd_preview;
                }

                // Update title
                if (data.prd_title) {
                    document.getElementById('prdTitle').textContent = data.prd_title;
                }

                // Donation prompt (only if they haven't said no even once)
                if (data.donation_prompt && donationRefusals === 0) {
                    showDonationPrompt(data.donation_message);
                }

                // Backroom debate (Stool vs Gomer)
                if (data.backroom) {
                    showBackroom(data.backroom);
                }

            } catch (error) {
                addMessage('assistant', '*scratches head*\n\nWell slap my thigh! Something went wrong. Please try again.');
            }

            document.getElementById('sendBtn').disabled = false;
        }

        function addMessage(role, content) {
            const messagesDiv = document.getElementById('messages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${role}`;
            msgDiv.innerHTML = content.replace(/\n/g, '<br>');
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function copyPRD() {
            const prd = document.getElementById('prdEditor').value;
            if (!prd) {
                alert('No PRD to copy yet!');
                return;
            }

            await navigator.clipboard.writeText(prd);
            fetch('/api/prd/count', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_id: sessionId })
            }).catch(() => {});

            const btn = document.querySelector('.copy-btn');
            const originalText = btn.textContent;
            btn.textContent = '‚úì Copied!';
            setTimeout(() => btn.textContent = originalText, 1500);
        }

        function showDonationPrompt(message) {
            document.getElementById('donationMessage').textContent = message;
            document.getElementById('donationModal').classList.add('active');
        }

        function donateYes() {
            document.getElementById('donationModal').classList.remove('active');
            window.open('https://buymeacoffee.com/snail3d', '_blank');
            addMessage('assistant', '*adjusts tie*\n\nWell I\'ll be! Homer\'s gonna be thrilled! You\'re the real deal. Much obliged!');
        }

        function donateNo() {
            document.getElementById('donationModal').classList.remove('active');
            donationRefusals++;
            addMessage('assistant', '*nods slowly*\n\nNo sweat at all! You just keep building great stuff. That\'s what matters around here!');
        }

        function showPrivacy() {
            document.getElementById('privacyModal').classList.add('active');
        }

        function closePrivacy() {
            document.getElementById('privacyModal').classList.remove('active');
        }

        function showBackroom(backroom) {
            document.getElementById('stoolMessage').textContent = backroom.stool || '';
            document.getElementById('gomerMessage').textContent = backroom.gomer || '';
            document.getElementById('backroomModal').classList.add('active');
        }

        function closeBackroom() {
            document.getElementById('backroomModal').classList.remove('active');
        }

        async function loadChatHistory() {
            // Load existing chat if session exists
            try {
                const response = await fetch(`/api/chat/${sessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    // Would load chat history here if endpoint exists
                }
            } catch (e) {
                // New chat
            }
        }
    </script>
</body>
</html>
