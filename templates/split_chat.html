<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>prplbry</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü´ê</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --text-primary: #e0e0e0;
            --text-secondary: #888;
            --accent: #ff6b35;
            --border: #2a2a2a;
            --divider: rgba(255,107,53,0.3);
            --input-bg: #1a1a1a;
        }

        .light-mode {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e5e5e5;
            --text-primary: #1a1a1a;
            --text-secondary: #666;
            --border: #e0e0e0;
            --divider: rgba(255,107,53,0.25);
            --input-bg: #f9f9f9;
        }

        body {
            font-family: 'SF Mono', Monaco, 'Consolas', 'Menlo', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Desktop: Side-by-side */
        @media (min-width: 769px) {
            body {
                flex-direction: row;
            }

            .chat-section {
                flex: 1;
                max-height: none;
                border-right: 2px solid var(--divider);
                border-bottom: none;
            }

            .prd-section {
                flex: 1;
            }
        }

        /* Mobile: Stacked (chat top, PRD bottom) */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
                overflow-y: auto;
            }

            .chat-section {
                min-height: 60vh;
                max-height: 70vh;
            }

            .prd-section {
                min-height: 30vh;
            }
        }

        /* Chat Section */
        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-bottom: 2px solid var(--divider);
            background: var(--bg-primary);
            min-width: 0;
        }

        .chat-header {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        .chat-title {
            font-size: 13px;
            font-weight: 500;
            letter-spacing: -0.3px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chat-title .logo {
            font-size: 14px;
        }

        .chat-title .prpl {
            color: #a855f7;
        }

        .chat-title .berry {
            color: #888;
        }

        /* Toggle Switch */
        .mode-toggle {
            position: relative;
            width: 44px;
            height: 24px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.15);
        }

        .mode-toggle:hover {
            border-color: var(--accent);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.15), 0 0 0 2px rgba(255,107,53,0.1);
        }

        .mode-toggle::after {
            content: '‚òÄÔ∏è';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: var(--text-secondary);
            border-radius: 50%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .light-mode .mode-toggle {
            background: var(--accent);
            border-color: var(--accent);
        }

        .light-mode .mode-toggle::after {
            content: 'üåô';
            left: 22px;
            background: #fff;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
        }

        .messages.drag-over {
            background: rgba(255,107,53,0.05);
        }

        .messages.drag-over::after {
            content: 'Drop PRD, image, or text here';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--accent);
            color: #fff;
            padding: 20px 40px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            z-index: 100;
            animation: fadeIn 0.2s ease-out;
            pointer-events: none;
        }

        .drop-zone-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 3px dashed var(--accent);
            border-radius: 8px;
            display: none;
            pointer-events: none;
            z-index: 50;
        }

        .messages.drag-over .drop-zone-overlay {
            display: block;
        }

        .message {
            max-width: 70%;
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 12px;
            line-height: 1.4;
        }

        .message.user {
            align-self: flex-end;
            background: var(--accent);
            color: #fff;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .message.assistant {
            align-self: flex-start;
            background: var(--accent);
            color: #fff;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            animation: orangeToPurple 5s ease-out forwards;
        }

        @keyframes orangeToPurple {
            0% {
                background: var(--accent);
            }
            100% {
                background: var(--bg-secondary);
                border-left: 3px solid #a855f7;
            }
        }

        /* Light mode override for assistant messages */
        .light-mode .message.assistant {
            animation: orangeToPurpleLight 5s ease-out forwards;
        }

        @keyframes orangeToPurpleLight {
            0% {
                background: var(--accent);
                color: #fff;
            }
            100% {
                background: var(--bg-tertiary);
                color: var(--text-primary);
                border-left: 3px solid #a855f7;
            }
        }

        .input-area {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
            background: var(--bg-secondary);
        }

        .chat-input {
            flex: 1;
            padding: 8px 12px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 12px;
            outline: none;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }

        .chat-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(255,107,53,0.1), inset 0 1px 2px rgba(0,0,0,0.05);
        }

        .send-btn {
            padding: 8px 16px;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            min-width: 70px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(255,107,53,0.2);
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(255,107,53,0.25);
        }

        .send-btn:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(255,107,53,0.2);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .send-btn.typing {
            background: #a855f7;
            box-shadow: 0 2px 4px rgba(168,85,247,0.3);
        }

        .send-btn.typing:hover:not(:disabled) {
            background: #b874f7;
            box-shadow: 0 3px 6px rgba(168,85,247,0.35);
        }

        .send-btn.fade-out {
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .send-btn.fade-in {
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
        }

        .send-btn.recording {
            background: #ef4444;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 3px 8px rgba(239,68,68,0.4);
            }
        }

        .recording-indicator {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #ef4444;
            color: #fff;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: 500;
            display: none;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            animation: slideUp 0.2s ease-out;
        }

        .recording-indicator.active {
            display: flex;
        }

        .recording-indicator .dot {
            width: 8px;
            height: 8px;
            background: #fff;
            border-radius: 50%;
            animation: blink 1s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* PRD Section - BOTTOM */
        .prd-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-primary);
        }

        .prd-header {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
            gap: 12px;
        }

        .prd-title-text {
            font-size: 11px;
            font-weight: 500;
            color: var(--accent);
            letter-spacing: -0.2px;
            flex-shrink: 0;
        }

        .dangerous-cmd {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 10px;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 4px 10px;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: -0.2px;
            opacity: 0.8;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .dangerous-cmd:hover {
            opacity: 1;
            background: var(--border);
        }

        .dangerous-cmd code {
            color: var(--accent);
            font-size: 10px;
        }

        .dangerous-cmd .copy-icon {
            font-size: 8px;
            opacity: 0.5;
        }

        @media (max-width: 600px) {
            .dangerous-cmd {
                white-space: normal;
                text-align: center;
                line-height: 1.4;
            }
        }

        .copy-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 12px;
            color: var(--text-primary);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
            flex-shrink: 0;
        }

        .copy-btn:hover {
            background: var(--bg-primary);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.12);
        }

        .copy-btn.copied {
            animation: copyPurpleToOrange 5s ease-out forwards;
        }

        @keyframes copyPurpleToOrange {
            0% {
                background: #a855f7;
                color: #fff;
                border-color: #a855f7;
                box-shadow: 0 2px 8px rgba(168,85,247,0.4);
            }
            100% {
                background: var(--bg-tertiary);
                color: var(--text-primary);
                border-color: var(--border);
                box-shadow: 0 1px 2px rgba(0,0,0,0.08);
            }
        }

        .prd-editor {
            flex: 1;
            padding: 16px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'SF Mono', Monaco, 'Consolas', monospace;
            font-size: 11px;
            line-height: 1.6;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: none;
            outline: none;
            resize: none;
        }

        /* API Key Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal h3 {
            font-size: 14px;
            margin-bottom: 12px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .modal p {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .api-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 12px;
            margin-bottom: 16px;
            outline: none;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }

        .api-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(255,107,53,0.1), inset 0 1px 2px rgba(0,0,0,0.05);
        }

        .modal-btn {
            width: 100%;
            padding: 10px 16px;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(255,107,53,0.2);
            transition: all 0.2s;
        }

        .modal-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(255,107,53,0.25);
        }

        /* Donation Modal */
        .donation-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .donation-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .donation-btn.yes {
            background: var(--accent);
            color: #fff;
            box-shadow: 0 2px 4px rgba(255,107,53,0.2);
        }

        .donation-btn.yes:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(255,107,53,0.25);
        }

        .donation-btn.no {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        }

        .donation-btn.no:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.12);
        }

        /* Privacy Modal */
        .privacy-link {
            font-size: 11px;
            color: var(--text-secondary);
            text-decoration: underline;
            cursor: pointer;
            margin-top: 12px;
            display: inline-block;
        }

        .privacy-link:hover {
            color: var(--text-primary);
        }

        .privacy-content {
            font-size: 12px;
            color: var(--text-primary);
            line-height: 1.8;
            max-height: 60vh;
            overflow-y: auto;
        }

        .privacy-content h4 {
            font-size: 14px;
            color: var(--accent);
            margin: 16px 0 8px 0;
        }

        .privacy-content p {
            margin-bottom: 12px;
        }

        .privacy-content ul {
            margin-left: 20px;
            margin-bottom: 12px;
        }

        .privacy-content li {
            margin-bottom: 8px;
        }

        /* Backroom Modal */
        .backroom-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .backroom-speaker {
            padding: 12px;
            border-radius: 8px;
            background: var(--bg-tertiary);
            animation: redToOrange 5s ease-out forwards;
        }

        .backroom-speaker.stool {
            border-left: 3px solid #e74c3c;
        }

        .backroom-speaker.gomer {
            border-left: 3px solid #27ae60;
        }

        @keyframes redToOrange {
            0% {
                background: var(--accent);
                border-left-color: var(--accent);
            }
            100% {
                background: var(--bg-tertiary);
                border-left-color: #e74c3c;
            }
        }

        .backroom-name {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stool .backroom-name {
            color: #e74c3c;
        }

        .gomer .backroom-name {
            color: #27ae60;
        }

        .backroom-message {
            font-size: 12px;
            color: var(--text-primary);
            line-height: 1.5;
        }

        .backroom-close {
            width: 100%;
            padding: 10px 16px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        }

        .backroom-close:hover {
            background: var(--bg-primary);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.12);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- API Key Modal -->
    <div class="modal-overlay" id="apiKeyModal">
        <div class="modal">
            <h3>üîë Groq API Key</h3>
            <p>Enter your free Groq API key to continue. Get it at console.groq.com</p>
            <input type="password" class="api-input" id="apiKeyInput" placeholder="gsk_...">
            <button class="modal-btn" onclick="saveApiKey()">Start</button>
            <span class="privacy-link" onclick="showPrivacy()">Privacy (we collect nothing)</span>
        </div>
    </div>

    <!-- Privacy Modal -->
    <div class="modal-overlay" id="privacyModal">
        <div class="modal">
            <h3>üîí Privacy (Super Simple)</h3>
            <div class="privacy-content">
                <h4>What we DON'T collect:</h4>
                <ul>
                    <li><strong>No names</strong> - We don't know who you are</li>
                    <li><strong>No emails</strong> - We can't email you</li>
                    <li><strong>No accounts</strong> - You don't sign up for anything</li>
                    <li><strong>No tracking</strong> - We don't follow you around</li>
                    <li><strong>No cookies</strong> - Well, just one tiny cookie to keep your chat working, but it disappears when you close your browser</li>
                    <li><strong>No selling your stuff</strong> - We have nothing to sell!</li>
                </ul>

                <h4>What DO we do with your stuff?</h4>
                <p>Nothing! Your chat messages and PRDs are gone as soon as you close the tab. We don't save them. We can't even see them.</p>

                <h4>So how does this work?</h4>
                <p>You bring your own Groq API key. That key talks directly to Groq. Your messages go from your computer to Groq and back. We're just the middleman who sets up the conversation.</p>

                <p><strong>We're like a paper cup - you use it, then it's gone. We keep nothing.</strong></p>

                <h4>Why?</h4>
                <p>Because privacy should be simple. No fine print. No tricks. Just nothing.</p>

                <h4>The boring part:</h4>
                <p>We use Cloudflare to keep the site fast and safe from bad guys. That's it.</p>
            </div>
            <button class="modal-btn" onclick="closePrivacy()" style="margin-top: 16px;">Got it</button>
        </div>
    </div>

    <!-- Backroom Modal -->
    <div class="modal-overlay" id="backroomModal">
        <div class="modal">
            <h3 style="color: var(--accent);">üéß The Back Room</h3>
            <div class="backroom-content">
                <div class="backroom-speaker stool">
                    <div class="backroom-name">üî¥ Stool (Skeptic)</div>
                    <div class="backroom-message" id="stoolMessage"></div>
                </div>
                <div class="backroom-speaker gomer">
                    <div class="backroom-name">üü¢ Gomer (Optimist)</div>
                    <div class="backroom-message" id="gomerMessage"></div>
                </div>
            </div>
            <button class="backroom-close" onclick="closeBackroom()">Got it, back to work</button>
        </div>
    </div>

    <!-- Donation Modal -->
    <div class="modal-overlay" id="donationModal">
        <div class="modal">
            <h3 style="color: var(--accent);">Hot dog! Look at you go!</h3>
            <p id="donationMessage" style="color: var(--text-primary); line-height: 1.6;"></p>
            <div class="donation-buttons">
                <button class="donation-btn yes" onclick="donateYes()">Yes, I'll support</button>
                <button class="donation-btn no" onclick="donateNo()">No thanks</button>
            </div>
        </div>
    </div>

    <!-- Chat Section -->
    <div class="chat-section">
        <div class="chat-header">
            <div class="chat-title">
                <span class="logo">ü´ê</span>
                <span class="prpl">prpl</span><span class="berry">bry</span>
            </div>
            <div class="mode-toggle" onclick="toggleMode()" id="modeBtn"></div>
        </div>

        <div class="messages" id="messages">
            <div class="drop-zone-overlay"></div>
            <div class="message assistant">
                Hi, I'm Ralph. I'm your sauce boss. Let's cook. üç≥üî•<br><br>
                What are we building today?
            </div>
        </div>

        <div class="input-area">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">Send</button>
        </div>

        <div class="recording-indicator" id="recordingIndicator">
            <span class="dot"></span>
            Recording... Release to send
        </div>
    </div>

    <!-- PRD Section -->
    <div class="prd-section">
        <div class="prd-header">
            <span class="prd-title-text" id="prdTitle"></span>
            <span class="dangerous-cmd" onclick="copyCommand()" title="Click to copy command">
                <code>claude --dangerously-skip-permissions</code>
            </span>
            <button class="copy-btn" onclick="copyPRD()">Copy</button>
        </div>
        <textarea class="prd-editor" id="prdEditor" readonly placeholder="Your PRD will appear here as we chat..."></textarea>
    </div>

    <script>
        let sessionId = '{{ session_id }}' || generateUUID();
        let groqApiKey = sessionStorage.getItem('groqApiKey') || '';
        let donationRefusals = 0;
        const MAX_DONATION_REQUESTS = 2;
        const GROQ_MODEL = 'llama-3.3-70b-versatile';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (!groqApiKey) {
                document.getElementById('apiKeyModal').classList.add('active');
            } else {
                loadChatHistory();
            }

            // Start language cycling animation on send button
            startLanguageCycling();

            // Setup send button events (click vs long press)
            setupSendButton();
        });

        function setupSendButton() {
            const sendBtn = document.getElementById('sendBtn');
            let pressTimer = null;
            let isLongPress = false;

            // Prevent click event after long press
            sendBtn.addEventListener('click', (e) => {
                if (isLongPress) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
            }, true); // Use capture phase

            // Mouse events
            sendBtn.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return; // Only left click
                isLongPress = false;
                pressTimer = setTimeout(() => {
                    isLongPress = true;
                    startRecording(e);
                }, 500);
            });

            sendBtn.addEventListener('mouseup', (e) => {
                clearTimeout(pressTimer);
                if (isLongPress) {
                    stopRecording(e);
                }
                // If not long press, let the onclick handle it
            });

            sendBtn.addEventListener('mouseleave', () => {
                clearTimeout(pressTimer);
                if (isLongPress) {
                    stopRecording();
                }
            });

            // Touch events
            sendBtn.addEventListener('touchstart', (e) => {
                isLongPress = false;
                pressTimer = setTimeout(() => {
                    isLongPress = true;
                    startRecording(e);
                }, 500);
            });

            sendBtn.addEventListener('touchend', (e) => {
                clearTimeout(pressTimer);
                if (isLongPress) {
                    e.preventDefault();
                    stopRecording(e);
                }
                // If not long press, let the onclick handle it
            });
        }

        // Language cycling for send button
        const sendButtonTexts = [
            { text: "Send", lang: "English" },
            { text: "Enviar", lang: "Spanish" },
            { text: "Envoyer", lang: "French" },
            { text: "Invia", lang: "Italian" },
            { text: "Enviar", lang: "Portuguese" },
            { text: "ÂèëÈÄÅ", lang: "Chinese" },
            { text: "ÈÄÅ‰ø°", lang: "Japanese" },
            { text: "Î≥¥ÎÇ¥Í∏∞", lang: "Korean" },
            { text: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å", lang: "Russian" },
            { text: "Senden", lang: "German" },
            { text: "Versturen", lang: "Dutch" },
            { text: "Wy≈õlij", lang: "Polish" },
            { text: "G√∂nder", lang: "Turkish" },
            { text: "◊©◊ú◊ó", lang: "Hebrew" },
            { text: "ÿ•ÿ±ÿ≥ÿßŸÑ", lang: "Arabic" },
            { text: "‡§≠‡•á‡§ú‡•á‡§Ç", lang: "Hindi" },
            { text: "Kirim", lang: "Indonesian" },
            { text: "G·ª≠i", lang: "Vietnamese" },
            { text: "‡∏™‡πà‡∏á", lang: "Thai" }
        ];

        let currentLangIndex = 0;
        let isCycling = true;

        function startLanguageCycling() {
            const sendBtn = document.getElementById('sendBtn');

            // Cycle every 2.5 seconds
            setInterval(() => {
                if (!isCycling) return;

                // Fade out
                sendBtn.classList.add('fade-out');

                setTimeout(() => {
                    // Change text
                    currentLangIndex = (currentLangIndex + 1) % sendButtonTexts.length;
                    sendBtn.textContent = sendButtonTexts[currentLangIndex].text;
                    sendBtn.title = sendButtonTexts[currentLangIndex].lang;

                    // Fade in
                    sendBtn.classList.remove('fade-out');
                    sendBtn.classList.add('fade-in');
                }, 500); // Wait for fade out to complete

            }, 2500); // Change every 2.5 seconds
        }

        // Stop cycling when user focuses on input
        const chatInput = document.getElementById('chatInput');
        chatInput.addEventListener('focus', () => {
            isCycling = false;
            // Reset to English
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.classList.add('fade-out');
            setTimeout(() => {
                sendBtn.textContent = 'Send';
                sendBtn.title = 'English';
                sendBtn.classList.remove('fade-out');
                sendBtn.classList.add('fade-in');
            }, 500);
        });

        chatInput.addEventListener('blur', () => {
            isCycling = true;
        });

        // Purple send button when typing
        chatInput.addEventListener('input', () => {
            const sendBtn = document.getElementById('sendBtn');
            if (chatInput.value.trim().length > 0) {
                sendBtn.classList.add('typing');
                isCycling = false;
                sendBtn.textContent = 'Send';
                sendBtn.title = 'English';
            } else {
                sendBtn.classList.remove('typing');
                isCycling = true;
            }
        });

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0;
                return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });
        }

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (key && key.startsWith('gsk_')) {
                groqApiKey = key;
                sessionStorage.setItem('groqApiKey', key);
                document.getElementById('apiKeyModal').classList.remove('active');
                loadChatHistory();
            } else {
                alert('Please enter a valid Groq API key (starts with gsk_)');
            }
        }

        function toggleMode() {
            document.body.classList.toggle('light-mode');
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            // Add user message
            addMessage('user', message);
            input.value = '';

            // Disable send
            document.getElementById('sendBtn').disabled = true;

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        session_id: sessionId,
                        grok_api_key: groqApiKey
                    })
                });

                const data = await response.json();
                sessionId = data.session_id || sessionId;

                // Add assistant message
                if (data.message) {
                    addMessage('assistant', data.message);
                }

                // Update PRD
                if (data.prd_preview) {
                    document.getElementById('prdEditor').value = data.prd_preview;
                }

                // Update title
                if (data.prd_title) {
                    document.getElementById('prdTitle').textContent = data.prd_title;
                }

                // Donation prompt (only if they haven't said no even once)
                if (data.donation_prompt && donationRefusals === 0) {
                    showDonationPrompt(data.donation_message);
                }

                // Backroom debate (Stool vs Gomer)
                if (data.backroom) {
                    showBackroom(data.backroom);
                }

            } catch (error) {
                addMessage('assistant', '*scratches head*\n\nWell slap my thigh! Something went wrong. Please try again.');
            }

            document.getElementById('sendBtn').disabled = false;
        }

        function addMessage(role, content) {
            const messagesDiv = document.getElementById('messages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${role}`;
            msgDiv.innerHTML = content.replace(/\n/g, '<br>');
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function copyPRD() {
            const prd = document.getElementById('prdEditor').value;
            if (!prd) {
                alert('No PRD to copy yet!');
                return;
            }

            await navigator.clipboard.writeText(prd);
            fetch('/api/prd/count', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_id: sessionId })
            }).catch(() => {});

            const btn = document.querySelector('.copy-btn');
            const originalText = btn.textContent;
            btn.textContent = '‚úì Copied!';
            btn.classList.add('copied');

            setTimeout(() => {
                btn.textContent = originalText;
                btn.classList.remove('copied');
            }, 5000);
        }

        async function copyCommand() {
            const command = 'claude --dangerously-skip-permissions';
            await navigator.clipboard.writeText(command);

            const cmdEl = document.querySelector('.dangerous-cmd');
            const originalHTML = cmdEl.innerHTML;
            cmdEl.innerHTML = '<code>‚úì Copied!</code>';

            setTimeout(() => {
                cmdEl.innerHTML = originalHTML;
            }, 2000);
        }

        // Voice recording variables
        let isRecording = false;
        let recognition = null;
        let recordingTimeout = null;
        let voiceTranscript = '';

        function startRecording(event) {
            // Don't prevent default - let the button setup handle it
            isRecording = true;
            voiceTranscript = '';

            const sendBtn = document.getElementById('sendBtn');
            const indicator = document.getElementById('recordingIndicator');

            sendBtn.classList.add('recording');
            sendBtn.textContent = 'Recording...';
            indicator.classList.add('active');

            // Initialize speech recognition
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';

                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            voiceTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    // Update indicator with live transcription
                    const displayText = interimTranscript || voiceTranscript || 'Recording... Release to send';
                    indicator.innerHTML = `<span class="dot"></span> ${displayText}`;
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    stopRecording();
                };

                recognition.onend = () => {
                    if (isRecording) {
                        // Restart if still recording (handles auto-stop)
                        try {
                            recognition.start();
                        } catch (e) {
                            stopRecording();
                        }
                    }
                };

                recognition.start();
            } else {
                indicator.innerHTML = '<span class="dot"></span> Voice not supported in this browser';
                setTimeout(stopRecording, 2000);
            }

            // Auto-stop after 30 seconds max
            recordingTimeout = setTimeout(() => {
                if (isRecording) stopRecording();
            }, 30000);
        }

        async function stopRecording(event) {
            if (!isRecording) return;
            if (event) event.preventDefault();

            isRecording = false;
            clearTimeout(recordingTimeout);

            const sendBtn = document.getElementById('sendBtn');
            const indicator = document.getElementById('recordingIndicator');
            const chatInput = document.getElementById('chatInput');

            sendBtn.classList.remove('recording');
            sendBtn.textContent = 'Send';
            indicator.classList.remove('active');

            if (recognition) {
                recognition.stop();

                // Wait a bit for final results
                await new Promise(resolve => setTimeout(resolve, 200));

                const transcript = voiceTranscript.trim();
                if (transcript) {
                    chatInput.value = transcript;
                    // Auto-send after short delay
                    setTimeout(() => sendMessage(), 300);
                }
            }

            recognition = null;
            voiceTranscript = '';
        }

        // Drag and Drop functionality
        const messagesDiv = document.getElementById('messages');

        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            messagesDiv.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Highlight drop zone
        ['dragenter', 'dragover'].forEach(eventName => {
            messagesDiv.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            messagesDiv.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            messagesDiv.classList.add('drag-over');
        }

        function unhighlight(e) {
            messagesDiv.classList.remove('drag-over');
        }

        // Handle dropped files
        messagesDiv.addEventListener('drop', handleDrop, false);

        async function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            const items = dt.items;

            handleFiles(files, items);
        }

        async function handleFiles(files, items) {
            if (files.length > 0) {
                for (let i = 0; i < files.length; i++) {
                    await processFile(files[i]);
                }
            }
        }

        async function processFile(file) {
            const fileType = file.type;
            const fileName = file.name;

            // Text files
            if (fileType.startsWith('text/') || fileName.endsWith('.txt') || fileName.endsWith('.md') || fileName.endsWith('.json')) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const content = e.target.result;
                    await processDroppedContent(content, fileName);
                };
                reader.readAsText(file);
            }
            // Image files
            else if (fileType.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const imageData = e.target.result;
                    await processImage(imageData, fileName);
                };
                reader.readAsDataURL(file);
            }
            // JSON PRD files
            else if (fileName.endsWith('.json')) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const prdData = JSON.parse(e.target.result);
                        await loadPRDFromJSON(prdData, fileName);
                    } catch (err) {
                        addMessage('assistant', '*scratches head*\n\nHmm, having trouble reading that JSON file. Could you make sure it\'s a valid PRD format?');
                    }
                };
                reader.readAsText(file);
            }
            else {
                addMessage('assistant', `*raises eyebrow*\n\nI'm not sure how to handle that file type (${fileType}). Try dropping a text file, image, or PRD JSON!`);
            }
        }

        async function processDroppedContent(content, fileName) {
            // Add user message showing what was dropped
            addMessage('user', `üìÑ Dropped: ${fileName}\n\n${content.substring(0, 200)}${content.length > 200 ? '...' : ''}`);

            // Send to Ralph for analysis
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `[Dropped file: ${fileName}]\n\n${content}\n\nPlease analyze this content and extract any relevant features, requirements, or information to add to the PRD. Summarize what you found and tell me what you're adding.`,
                        session_id: sessionId,
                        grok_api_key: groqApiKey
                    })
                });

                const data = await response.json();

                if (data.message) {
                    addMessage('assistant', data.message);
                }

                if (data.prd_preview) {
                    document.getElementById('prdEditor').value = data.prd_preview;
                }
            } catch (error) {
                console.error('Error processing dropped content:', error);
                addMessage('assistant', '*looks confused*\n\nSomething went wrong processing that file. Mind trying again?');
            }
        }

        async function processImage(imageData, fileName) {
            // Add user message showing image was dropped
            addMessage('user', `üñºÔ∏è Dropped: ${fileName}\n\n[Image uploaded - analyzing...]`);

            try {
                const response = await fetch('/api/chat/analyze-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image: imageData,
                        filename: fileName,
                        session_id: sessionId,
                        grok_api_key: groqApiKey
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    addMessage('assistant', data.message || '*studies image carefully*\n\nInteresting! Let me add those details to the PRD.');

                    if (data.prd_preview) {
                        document.getElementById('prdEditor').value = data.prd_preview;
                    }
                } else {
                    addMessage('assistant', '*squints at image*\n\nI can see this image, but I\'m having trouble extracting the details. Could you describe what you\'d like me to add from it?');
                }
            } catch (error) {
                addMessage('assistant', '*rubs eyes*\n\nMy vision\'s a bit fuzzy right now. Could you tell me what\'s in that image and what you\'d like me to add to the PRD?');
            }
        }

        async function loadPRDFromJSON(prdData, fileName) {
            const prd = prdData.prd || prdData.prd_data || prdData;

            if (!prd || !prd.pn) {
                addMessage('assistant', '*scratches head*\n\nThis doesn\'t look like a valid PRD file. Make sure it has the project name and structure!');
                return;
            }

            // Restore the PRD to the editor
            document.getElementById('prdEditor').value = format_prd_display(prd, compressed=true);

            // Ask Ralph to review and summarize
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `[Loading saved PRD: ${fileName}]\n\nI'm loading an existing PRD. Please review it, summarize what we've built so far, and tell me you're ready to continue adding to it.\n\nPRD: ${JSON.stringify(prd)}`,
                        session_id: sessionId,
                        grok_api_key: groqApiKey
                    })
                });

                const data = await response.json();

                if (data.message) {
                    addMessage('assistant', data.message);
                }
            } catch (error) {
                addMessage('assistant', `*adjusts tie*\n\nAlright, I've loaded **${prd.pn}**! \n\nI can see we have ${sum(len(cat.get('t', [])) for cat in prd.get('p', {}).values())} tasks across ${len(prd.get('p', {}))} phases.\n\n*rubs hands together*\n\nWhat should we add next?`);
            }
        }

        // Also handle paste events
        document.addEventListener('paste', async (e) => {
            const items = e.clipboardData.items;

            for (let i = 0; i < items.length; i++) {
                const item = items[i];

                if (item.type === 'text/plain') {
                    item.getAsString(async (text) => {
                        if (text.length > 100) {  // Only process longer pastes
                            await processDroppedContent(text, 'pasted-content');
                        }
                    });
                } else if (item.type.startsWith('image/')) {
                    const file = item.getAsFile();
                    await processFile(file);
                }
            }
        });

        function showDonationPrompt(message) {
            document.getElementById('donationMessage').textContent = message;
            document.getElementById('donationModal').classList.add('active');
        }

        function donateYes() {
            document.getElementById('donationModal').classList.remove('active');
            window.open('https://buymeacoffee.com/snail3d', '_blank');
            addMessage('assistant', '*adjusts tie*\n\nWell I\'ll be! Homer\'s gonna be thrilled! You\'re the real deal. Much obliged!');
        }

        function donateNo() {
            document.getElementById('donationModal').classList.remove('active');
            donationRefusals++;
            addMessage('assistant', '*nods slowly*\n\nNo sweat at all! You just keep building great stuff. That\'s what matters around here!');
        }

        function showPrivacy() {
            document.getElementById('privacyModal').classList.add('active');
        }

        function closePrivacy() {
            document.getElementById('privacyModal').classList.remove('active');
        }

        function showBackroom(backroom) {
            document.getElementById('stoolMessage').textContent = backroom.stool || '';
            document.getElementById('gomerMessage').textContent = backroom.gomer || '';
            document.getElementById('backroomModal').classList.add('active');
        }

        function closeBackroom() {
            document.getElementById('backroomModal').classList.remove('active');
        }

        async function loadChatHistory() {
            // Load existing chat if session exists
            try {
                const response = await fetch(`/api/chat/${sessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    // Would load chat history here if endpoint exists
                }
            } catch (e) {
                // New chat
            }
        }
    </script>
</body>
</html>
